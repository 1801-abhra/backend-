<!DOCTYPE html>
<html>
<head>
<title>Driver Dashboard</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<h1>ðŸš• Driver Dashboard</h1>

<div id="rides"></div>

<script>
const driverId = localStorage.getItem("userId");

if (!driverId) {
alert("Session expired. Please login again.");
window.location.href = "/index.html";
}
const API_BASE = "https://traverse-backend-mvdv.onrender.com";

const role = localStorage.getItem("role");

if (role !== "driver") {
alert("Access denied. Drivers only.");
window.location.href = "/index.html";
}

const socket = io(API_BASE);

socket.on("connect", () => {
console.log("Driver connected:", socket.id);
});

socket.on("ride:new", (ride) => {
addRide(ride);
});

async function loadRides() {
const res = await fetch(`${API_BASE}/api/rides`);
const rides = await res.json();
rides.forEach(addRide);
}
function addRide(ride) {
if (ride.status !== "requested") return;

const div = document.createElement("div");
div.style.border = "1px solid #ccc";
div.style.padding = "10px";
div.style.marginBottom = "10px";

div.innerHTML = `
<p><b>Pickup:</b> ${ride.pickup.address}</p>
<p><b>Drop:</b> ${ride.drop.address}</p>
<p><b>Status:</b> ${ride.status}</p>
<button onclick="updateStatus('${ride._id}', 'accepted')">Accept</button>
<button onclick="updateStatus('${ride._id}', 'rejected')">Reject</button>
`;

document.getElementById("rides").appendChild(div);
}

async function updateStatus(id, status) {
const driverId = localStorage.getItem("userId");

if (!driverId) {
alert("Driver not logged in");
return;
}

await fetch(`${API_BASE}/api/rides/${id}/status`, {
method: "PATCH",
headers: {
"Content-Type": "application/json",
},
body: JSON.stringify({
status,
driverId,
}),
});

alert(`Ride ${status}`);
}


</script>

</body>
</html>
