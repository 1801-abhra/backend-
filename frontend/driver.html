<!DOCTYPE html>
<html>
<head>
<title>Driver Dashboard</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<h1>ðŸš• Driver Dashboard</h1>

<div id="rides"></div>

<script>
const driverId = localStorage.getItem("userId");
const role = localStorage.getItem("role");

if (!driverId || driverId === "undefined") {
alert("Invalid session. Please login again.");
localStorage.clear();
window.location.href = "/index.html";
}

if (role !== "driver") {
alert("Access denied. Drivers only.");
localStorage.clear();
window.location.href = "/index.html";
}

const API_BASE = "https://traverse-backend-mvdv.onrender.com";
const socket = io(API_BASE);

socket.on("connect", () => {
console.log("Driver connected:", socket.id);
});

socket.on("ride:new", (ride) => {
addRide(ride);
});

async function loadRides() {
const res = await fetch(`${API_BASE}/api/rides`);
const rides = await res.json();
rides.forEach(addRide);
}
function addRide(ride) {
if (ride.status !== "requested") return;

const div = document.createElement("div");
  div.id = `ride-${ride._id}`;
div.style.border = "1px solid #ccc";
div.style.padding = "10px";
div.style.marginBottom = "10px";

div.innerHTML = `
<p><b>Pickup:</b> ${ride.pickup.address}</p>
<p><b>Drop:</b> ${ride.drop.address}</p>
<p><b>Status:</b> ${ride.status}</p>
<button onclick="updateStatus('${ride._id}', 'accepted')">Accept</button>
<button onclick="updateStatus('${ride._id}', 'rejected')">Reject</button>
`;

document.getElementById("rides").appendChild(div);
}

async function updateStatus(id, status) {
const driverId = localStorage.getItem("userId");

try {
const res = await fetch(`${API_BASE}/api/rides/${id}/status`, {
method: "PATCH",
headers: {
"Content-Type": "application/json"
},
body: JSON.stringify({
status: status,
driverId: driverId
})
});

const data = await res.json();

if (!res.ok) {
alert(data.error || "Failed to update ride");
return;
}

alert(`Ride ${status}`);

// âœ… REMOVE ride from dashboard immediately
document.getElementById(`ride-${id}`).remove();

} catch (err) {
console.error(err);
alert("Server error");
}
}


</script>

</body>
</html>
